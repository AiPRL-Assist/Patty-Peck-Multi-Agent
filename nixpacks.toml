# Railway Python + Node deployment (monolithic frontend + backend)
providers = ["python"]

[phases.setup]
nixPkgs = ["python311", "nodejs_20"]

[phases.build]
cmds = [
    "python -m prisma generate",
    "cd frontend && npm install && npm run build"
]

[start]
# CRITICAL: Convert DATABASE_URL from postgresql+asyncpg:// to postgresql:// for Prisma
# Railway uses postgresql+asyncpg:// but Prisma needs postgresql://
# Also convert ssl=require to sslmode=require
cmd = """
export DATABASE_URL=$(echo $DATABASE_URL | sed 's/postgresql+asyncpg/postgresql/g' | sed 's/ssl=require/sslmode=require/g')
echo "ðŸ”§ DATABASE_URL (for Prisma): ${DATABASE_URL:0:60}..."
echo "ðŸ”§ Running prisma db push..."
python -m prisma db push --skip-generate
echo "âœ… Prisma tables ready"
uvicorn main:app --host 0.0.0.0 --port $PORT
"""
